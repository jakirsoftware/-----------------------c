<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script>
    function contactDropdown() {
      google.script.run.withSuccessHandler(function(contacts) {
        let contactSelect = document.getElementById("contact");
        contacts.forEach(function(contact) {
          let option = document.createElement("option");
          option.value = contact[0]; // Assuming contact name is in column A
          option.text = contact[0];  // Display contact name
          contactSelect.appendChild(option);
        });
      }).getContactList();
    }

    function getContactValue() {
      let contactName = document.getElementById("contact").value;
      if (contactName) {
        google.script.run.withSuccessHandler(function(contactValue) {
          document.getElementById("contactValue").value = contactValue || "No details found";
        }).getContactValue(contactName);
      }
    }

    function addItem() {
      let table = document.getElementById("invTable").getElementsByTagName('tbody')[0];
      let newRow = table.insertRow();
      
      newRow.innerHTML = `
        <td><input type="text" class="product" placeholder="Product Name"></td>
        <td><input type="number" class="price" value="0" onchange="updateTotal()"></td>
        <td><input type="number" class="quantity" value="1" onchange="updateTotal()"></td>
        <td class="total">0.00</td>
        <td><button onclick="removeItem(this)">Delete</button></td>
      `;
    }

    function removeItem(button) {
      let row = button.parentNode.parentNode;
      row.parentNode.removeChild(row);
      updateTotal();
    }

    function updateTotal() {
      let total = 0;
      document.querySelectorAll("#invTable tbody tr").forEach(row => {
        let price = parseFloat(row.querySelector(".price").value) || 0;
        let quantity = parseFloat(row.querySelector(".quantity").value) || 0;
        let amount = price * quantity;
        row.querySelector(".total").innerText = amount.toFixed(2);
        total += amount;
      });
      document.getElementById("grandTotal").innerText = total.toFixed(2);
    }

    function saveInvoice() {
      let invoiceNumber = document.getElementById("invoiceNumber").value;
      let contact = document.getElementById("contact").value;
      let items = [];

      document.querySelectorAll("#invTable tbody tr").forEach(row => {
        let product = row.querySelector(".product").value;
        let price = row.querySelector(".price").value;
        let quantity = row.querySelector(".quantity").value;
        let total = row.querySelector(".total").innerText;

        if (product && price && quantity) {
          items.push({ product, price, quantity, total });
        }
      });

      if (!invoiceNumber || !contact || items.length === 0) {
        alert("Please enter an invoice number, contact name, and at least one item.");
        return;
      }

      let invoiceData = { invoiceNumber, contact, invoice: items };

      google.script.run.withSuccessHandler(response => {
        alert(response);
        resetFields(); // Call function to reset the form after saving
      }).saveInvoice(invoiceData);
    }

    function resetFields() {
      document.getElementById("invoiceNumber").value = "";
      document.getElementById("contact").value = "";
      document.querySelector("#invTable tbody").innerHTML = ""; // Clears all added items
      document.getElementById("grandTotal").innerText = "0.00"; // Reset total
    }

    window.onload = function() {
      contactDropdown(); // Populate contact dropdown when the page loads
    };
  </script>
</head>
<body>
  <h2>Sales Invoice</h2>
  
  <label>Invoice Number: <input type="text" id="invoiceNumber"></label>
  
  <label for="contact">Contact Name: </label>
  <select id="contact" onchange="getContactValue()">
    <option value="">Select Contact</option>
  </select>
  
  <label for="contactValue">Contact Value: </label>
  <input type="text" id="contactValue" readonly>

  <table id="invTable" border="1">
    <thead>
      <tr>
        <th>Product</th>
        <th>Price</th>
        <th>Qty</th>
        <th>Total</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="addItem()">Add Item</button>
  <h3>Grand Total: $<span id="grandTotal">0.00</span></h3>
  <button onclick="saveInvoice()">Save Invoice</button>
</body>
</html>
function doGet() {
  return HtmlService.createHtmlOutputFromFile('index')
      .setTitle('Sales Invoice');
}



function getContactList() {
  var sheet = SpreadsheetApp.openById('1bP8grH5hV-Ywl6PYqXbbvD8b5UgzeTh1xR8axpeo0Ng1').getSheetByName("Contact");
  var data = sheet.getRange("A2:A").getValues(); // Get contact names from column A
  return data.filter(function(row) { return row[0] != ""; }); // Remove empty rows
}

function getContactValue(contactName) {
  var sheet = SpreadsheetApp.openById('1bP8grH5hV-Ywl6PYqXbbvD8b5UgzeTh1xR8axpeo0Ng1').getSheetByName("Contact");
  var data = sheet.getRange("A2:B").getValues(); // Get contact data from columns A and B
  for (var i = 0; i < data.length; i++) {
    if (data[i][0] === contactName) {
      return data[i][1]; // Return corresponding value from column B
    }
  }
  return null; // Return null if contact is not found
}








function saveInvoice(data) {
  var sheetId = '1bP8grH5hV-Ywl6PYqXbbvD8b5UgzeTh1xR8axpeo0Ng1'; // Replace with your Google Sheet ID
  var sheet = SpreadsheetApp.openById(sheetId).getSheetByName("Invoice");

  if (!sheet) {
    sheet = SpreadsheetApp.openById(sheetId).insertSheet("Invoice");
    sheet.appendRow(["Date", "Invoice Number", "Contact Name", "Product", "Price", "Quantity", "Total"]);
  }

  var date = new Date();
  
  data.invoice.forEach(item => {
    sheet.appendRow([
      date.toLocaleDateString(),
      data.invoiceNumber,
      data.contact,
      item.product,
      item.price,
      item.quantity,
      item.total
    ]);
  });

  return "Invoice saved successfully!";
}
